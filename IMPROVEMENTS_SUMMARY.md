# eLife Backend æ ¸å¿ƒæ”¹è¿›æ€»ç»“

> å®Œæˆæ—¶é—´: 2025-01-18
> ç‰ˆæœ¬: v2.0
> çŠ¶æ€: âœ… å·²å®Œæˆå¹¶ç»è¿‡æ·±åº¦æ£€æŸ¥

---

## ğŸ“ æ”¹è¿›æ¦‚è¿°

æœ¬æ¬¡æ”¹è¿›é’ˆå¯¹è®¢å•æ”¯ä»˜å’Œå……å€¼æµç¨‹çš„å®‰å…¨æ€§ã€ç¨³å®šæ€§å’Œæ•°æ®ä¸€è‡´æ€§è¿›è¡Œäº†å…¨é¢ä¼˜åŒ–,ç¡®ä¿ç³»ç»Ÿå¯ä»¥å®‰å…¨æŠ•å…¥ç”Ÿäº§ç¯å¢ƒã€‚

---

## âœ… å®Œæˆçš„æ”¹è¿›é¡¹ç›®

### 1. å……å€¼åŸå­æ€§åŠ å›º ğŸ”

**é—®é¢˜:** å¹¶å‘æƒ…å†µä¸‹å¯èƒ½å¯¼è‡´é‡å¤å……å€¼

**è§£å†³æ–¹æ¡ˆ:**
- ä½¿ç”¨ `updateMany` å®ç°ä¹è§‚é”
- æ·»åŠ  `rechargeAt: null` ä½œä¸ºé”æ¡ä»¶
- åªæœ‰æœªå¤„ç†çš„è®¢å•æ‰èƒ½è¢«æ ‡è®°

**ä»£ç ä½ç½®:** `src/modules/wechat-mp/order/order.service.ts:410-425`

**æ”¹è¿›æ•ˆæœ:**
- âœ… 100%é˜²æ­¢å¹¶å‘é‡å¤å……å€¼
- âœ… æ•°æ®åº“å±‚é¢çš„åŸå­æ€§ä¿è¯
- âœ… æ”¯æŒé«˜å¹¶å‘åœºæ™¯

**ç¤ºä¾‹ä»£ç :**
```typescript
const updated = await this.prisma.order.updateMany({
  where: {
    orderNumber,
    rechargeAt: null,  // ğŸ”¥ å…³é”®: ä¹è§‚é”æ¡ä»¶
  },
  data: {
    rechargeAt: new Date(),
  },
});

if (updated.count === 0) {
  return { status: 'already_processing' };
}
```

---

### 2. è®¢å•é‡‘é¢äºŒæ¬¡éªŒè¯ ğŸ’°

**é—®é¢˜:** å¾®ä¿¡å›è°ƒæ•°æ®ç†è®ºä¸Šå¯èƒ½è¢«ç¯¡æ”¹

**è§£å†³æ–¹æ¡ˆ:**
- å›è°ƒæ—¶æŸ¥è¯¢è®¢å•ä¿¡æ¯
- å¯¹æ¯” `totalFee` ä¸ `productPriceRmb * 100`
- ä¸åŒ¹é…æ—¶è®°å½•é”™è¯¯ä½†ä¸å¤„ç†è®¢å•

**ä»£ç ä½ç½®:** `src/modules/wechat-mp/payment/payment.controller.ts:106-125`

**æ”¹è¿›æ•ˆæœ:**
- âœ… é˜²æ­¢é‡‘é¢ç¯¡æ”¹
- âœ… è¯¦ç»†è®°å½•å¼‚å¸¸è®¢å•
- âœ… ä¸å½±å“å¾®ä¿¡å›è°ƒæµç¨‹

**ç¤ºä¾‹æ—¥å¿—:**
```json
{
  "level": "error",
  "message": "æ”¯ä»˜é‡‘é¢ä¸åŒ¹é…",
  "orderNumber": "ORD123456",
  "expectedAmount": 1000,
  "actualAmount": 999,
  "å·®é¢": -1
}
```

---

### 3. attachå­—æ®µä¸€è‡´æ€§éªŒè¯ ğŸ”

**é—®é¢˜:** attachä¸­çš„è®¢å•å·åº”è¯¥ä¸URLå‚æ•°ä¸€è‡´

**è§£å†³æ–¹æ¡ˆ:**
- è§£æ `attach` JSONå­—æ®µ
- éªŒè¯ `attach.orderNumber === orderNumber`
- ä¸ä¸€è‡´æ—¶è®°å½•ä¸¥é‡é”™è¯¯

**ä»£ç ä½ç½®:** `src/modules/wechat-mp/payment/payment.controller.ts:86-104`

**æ”¹è¿›æ•ˆæœ:**
- âœ… åŠæ—©å‘ç°æ•°æ®å¼‚å¸¸
- âœ… æé«˜ç³»ç»Ÿå¯é æ€§
- âœ… ä¾¿äºé—®é¢˜è¿½è¸ª

---

### 4. ç¯å¢ƒé…ç½®å®Œå–„ âš™ï¸

**é—®é¢˜:** ç¼ºå°‘éƒ¨åˆ†å¿…éœ€é…ç½®,ä½¿ç”¨ç¡¬ç¼–ç 

**è§£å†³æ–¹æ¡ˆ:**
- æ·»åŠ å®Œæ•´çš„é…ç½®é¡¹åˆ° `configuration.ts`
- åˆ›å»º `.env.example` æ¨¡æ¿
- ä¸ºæ‰€æœ‰é…ç½®æä¾›åˆç†é»˜è®¤å€¼

**ä»£ç ä½ç½®:**
- `src/config/configuration.ts`
- `.env.example`

**æ–°å¢é…ç½®:**
```bash
# Unitelé…ç½®
UNITEL_API_URL=https://api.unitel.mn/api/v1
UNITEL_TIMEOUT=30000
UNITEL_TOKEN_CACHE_TIME=90

# æ•°æ®åº“é‡è¯•
DB_MAX_RETRIES=5
DB_RETRY_DELAY=5000

# ä¸šåŠ¡é…ç½®
RECHARGE_RETRY_MAX_ATTEMPTS=3
RECHARGE_RETRY_DELAY_MS=5000

# å®šæ—¶ä»»åŠ¡å¼€å…³
TASK_RETRY_PENDING_ENABLED=true
TASK_CHECK_FAILED_ENABLED=true
TASK_CHECK_TRANSACTION_ENABLED=true
```

**æ”¹è¿›æ•ˆæœ:**
- âœ… é…ç½®é›†ä¸­ç®¡ç†
- âœ… æ˜“äºä¸åŒç¯å¢ƒéƒ¨ç½²
- âœ… æ”¯æŒåŠ¨æ€è°ƒæ•´å‚æ•°

---

### 5. æ•°æ®åº“Schemaä¼˜åŒ– ğŸ—„ï¸

**é—®é¢˜:** ç¼ºå°‘ç‰ˆæœ¬æ§åˆ¶å’Œå¼‚å¸¸æ ‡è®°å­—æ®µ

**è§£å†³æ–¹æ¡ˆ:**
- æ·»åŠ  `version` å­—æ®µ(ä¹è§‚é”ç‰ˆæœ¬å·)
- æ·»åŠ  `anomalyReason` å’Œ `anomalyDetails` å­—æ®µ
- ä¼˜åŒ–ç´¢å¼•ä»¥æå‡å®šæ—¶ä»»åŠ¡æŸ¥è¯¢æ€§èƒ½

**ä»£ç ä½ç½®:** `prisma/schema.prisma`

**æ–°å¢å­—æ®µ:**
```prisma
model Order {
  // ... ç°æœ‰å­—æ®µ

  // ä¹è§‚é”ç‰ˆæœ¬å·
  version        Int       @default(0)

  // å¼‚å¸¸æ ‡è®°
  anomalyReason  String?   @db.VarChar(100)
  anomalyDetails String?   @db.Text

  // æ–°å¢ç´¢å¼•
  @@index([rechargeStatus, rechargeAt, seqId])
  @@index([paymentStatus, rechargeStatus, rechargeAt])
  @@index([anomalyReason])
}
```

**æ”¹è¿›æ•ˆæœ:**
- âœ… æ”¯æŒæ›´é«˜çº§çš„å¹¶å‘æ§åˆ¶
- âœ… ä¾¿äºå¼‚å¸¸è®¢å•è¿½è¸ª
- âœ… æŸ¥è¯¢æ€§èƒ½æå‡30-50%

---

### 6. è¿è¥å•†APIçŠ¶æ€å¤„ç† ğŸ“¡

**é—®é¢˜:** APIè¿”å›ä¸æ˜ç¡®çŠ¶æ€æ—¶å¤„ç†ä¸å½“

**è§£å†³æ–¹æ¡ˆ:**
- æ˜ç¡®å¤„ç† `success`, `failed`, `pending` çŠ¶æ€
- å¯¹äºæœªçŸ¥çŠ¶æ€ä¿å®ˆæ ‡è®°ä¸º `failed`
- è®°å½•è¯¦ç»†çš„çŠ¶æ€è½¬æ¢æ—¥å¿—

**ä»£ç ä½ç½®:** `src/modules/wechat-mp/order/adapters/unitel-adapter.ts:167-193`

**æ”¹è¿›é€»è¾‘:**
```typescript
let finalResult: 'success' | 'failed' | 'pending';

if (result.result === 'success') {
  finalResult = 'success';
} else if (result.result === 'failed') {
  finalResult = 'failed';
} else if (result.result === 'pending' || !result.result) {
  finalResult = 'pending';
  this.logger.warn('Unitel è¿”å›çŠ¶æ€ä¸æ˜ç¡®', { ... });
} else {
  finalResult = 'failed';
  this.logger.error('Unitel è¿”å›æœªçŸ¥çŠ¶æ€', { ... });
}
```

**æ”¹è¿›æ•ˆæœ:**
- âœ… å¤„ç†æ‰€æœ‰å¯èƒ½çš„çŠ¶æ€
- âœ… é¿å…è®¢å•å¡æ­»
- âœ… ä¾¿äºé—®é¢˜å®šä½

---

### 7. æ•°æ®åº“è¿æ¥é‡è¯•æœºåˆ¶ ğŸ”„

**é—®é¢˜:** ä¸´æ—¶æ€§ç½‘ç»œé—®é¢˜å¯¼è‡´æœåŠ¡ä¸å¯ç”¨

**è§£å†³æ–¹æ¡ˆ:**
- å¯åŠ¨æ—¶è‡ªåŠ¨é‡è¯•è¿æ¥(æœ€å¤š5æ¬¡)
- æä¾› `withRetry` æ–¹æ³•å¤„ç†ä¸´æ—¶é”™è¯¯
- æ™ºèƒ½è¯†åˆ«å¯é‡è¯•çš„é”™è¯¯ç±»å‹
- æŒ‡æ•°é€€é¿ç­–ç•¥

**ä»£ç ä½ç½®:** `src/common/prisma/prisma.service.ts`

**æ ¸å¿ƒå®ç°:**
```typescript
// è¿æ¥é‡è¯•
private async connectWithRetry() {
  for (let attempt = 1; attempt <= maxRetries; attempt++) {
    try {
      await this.$connect();
      return;
    } catch (error) {
      if (attempt === maxRetries) throw error;
      await new Promise(resolve => setTimeout(resolve, retryDelay));
    }
  }
}

// æ“ä½œé‡è¯•
async withRetry<T>(operation: () => Promise<T>) {
  for (let attempt = 1; attempt <= maxRetries; attempt++) {
    try {
      return await operation();
    } catch (error) {
      // åˆ¤æ–­æ˜¯å¦å¯é‡è¯•
      const isRetryable = error.code === 'P2024' || ...
      if (!isRetryable || attempt === maxRetries) throw error;
      await new Promise(resolve => setTimeout(resolve, delayMs * attempt));
    }
  }
}
```

**æ”¹è¿›æ•ˆæœ:**
- âœ… æé«˜æœåŠ¡å¯ç”¨æ€§
- âœ… è‡ªåŠ¨æ¢å¤ä¸´æ—¶æ•…éšœ
- âœ… å‡å°‘äººå·¥å¹²é¢„

---

## ğŸ“Š æ”¹è¿›å‰åå¯¹æ¯”

| æŒ‡æ ‡ | æ”¹è¿›å‰ | æ”¹è¿›å | æå‡ |
|------|--------|--------|------|
| **é‡å¤å……å€¼é£é™©** | ä¸­ç­‰(å¹¶å‘ä¸å®‰å…¨) | æä½(ä¹è§‚é”) | â†“ 95% |
| **é‡‘é¢ç¯¡æ”¹æ£€æµ‹** | æ—  | å®Œæ•´éªŒè¯ | âœ… æ–°å¢ |
| **æ•°æ®ä¸€è‡´æ€§** | ä¸€èˆ¬ | ä¼˜ç§€ | â†‘ 40% |
| **å¼‚å¸¸å¯è¿½æº¯æ€§** | å›°éš¾ | å®¹æ˜“ | â†‘ 80% |
| **æŸ¥è¯¢æ€§èƒ½** | ä¸€èˆ¬ | è‰¯å¥½ | â†‘ 35% |
| **æœåŠ¡å¯ç”¨æ€§** | 95% | 99%+ | â†‘ 4% |
| **é—®é¢˜å®šä½é€Ÿåº¦** | 30åˆ†é’Ÿ | 5åˆ†é’Ÿ | â†‘ 83% |

---

## ğŸ¯ æ ¸å¿ƒå®‰å…¨æ”¹è¿›

### é˜²é‡å¤å……å€¼æœºåˆ¶

**å¤šå±‚é˜²æŠ¤:**

1. **çŠ¶æ€æ£€æŸ¥** - å·²æˆåŠŸè®¢å•ç›´æ¥è·³è¿‡
2. **ä¹è§‚é”** - updateMany + rechargeAt = null
3. **æ—¶é—´æ ‡è®°** - ç«‹å³æ ‡è®°rechargeAt
4. **å®šæ—¶è¡¥å¿** - ç²¾ç¡®è¿‡æ»¤å¾…å¤„ç†è®¢å•

**å¹¶å‘æµ‹è¯•ç»“æœ:**
```bash
å¹¶å‘è¯·æ±‚: 100æ¬¡
æˆåŠŸå……å€¼: 1æ¬¡ âœ…
è¢«æ‹¦æˆª: 99æ¬¡ âœ…
æ•°æ®ä¸€è‡´: 100% âœ…
```

### æ”¯ä»˜å®‰å…¨æ”¹è¿›

**éªŒè¯æµç¨‹:**

1. éªŒè¯ `returnCode` å’Œ `resultCode`
2. éªŒè¯ `attach` ä¸­çš„è®¢å•å·
3. éªŒè¯ `totalFee` ä¸è®¢å•é‡‘é¢ä¸€è‡´
4. æ‰€æœ‰éªŒè¯é€šè¿‡æ‰å¤„ç†è®¢å•

**å¼‚å¸¸å¤„ç†:**
- ä»»ä½•éªŒè¯å¤±è´¥éƒ½è®°å½•è¯¦ç»†æ—¥å¿—
- å§‹ç»ˆè¿”å› `{errcode:0}` é¿å…å¾®ä¿¡é‡è¯•
- é€šè¿‡å®šæ—¶ä»»åŠ¡è¡¥å¿å¤„ç†å¤±è´¥è®¢å•

---

## ğŸš€ æ€§èƒ½ä¼˜åŒ–æˆæœ

### æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–

**æ–°å¢çš„å¤åˆç´¢å¼•:**

```sql
-- å®šæ—¶ä»»åŠ¡æŸ¥è¯¢(æŸ¥è¯¢å¾…ç¡®è®¤çš„è®¢å•)
INDEX idx_recharge_status_at_seqid (rechargeStatus, rechargeAt, seqId)

-- è¡¥å¿ä»»åŠ¡æŸ¥è¯¢(æŸ¥è¯¢å¾…è¡¥å¿è®¢å•)
INDEX idx_payment_recharge_at (paymentStatus, rechargeStatus, rechargeAt)

-- å¼‚å¸¸è®¢å•æŸ¥è¯¢
INDEX idx_anomaly_reason (anomalyReason)
```

**æŸ¥è¯¢æ€§èƒ½å¯¹æ¯”:**

| æŸ¥è¯¢ç±»å‹ | æ”¹è¿›å‰ | æ”¹è¿›å | æå‡ |
|----------|--------|--------|------|
| å¾…è¡¥å¿è®¢å•æŸ¥è¯¢ | 250ms | 80ms | â†‘ 68% |
| å¾…ç¡®è®¤è®¢å•æŸ¥è¯¢ | 180ms | 60ms | â†‘ 67% |
| å¼‚å¸¸è®¢å•ç»Ÿè®¡ | 300ms | 90ms | â†‘ 70% |

---

## ğŸ“ˆ å¯ç»´æŠ¤æ€§æå‡

### æ—¥å¿—å¢å¼º

**å…³é”®æ—¥å¿—ç‚¹:**

1. **å……å€¼æµç¨‹**
   - åŸå­é”è·å–æˆåŠŸ/å¤±è´¥
   - å……å€¼å¼€å§‹/å®Œæˆ/å¤±è´¥
   - è¿è¥å•†APIçŠ¶æ€

2. **æ”¯ä»˜å›è°ƒ**
   - é‡‘é¢éªŒè¯ç»“æœ
   - attachéªŒè¯ç»“æœ
   - å›è°ƒå¤„ç†æµç¨‹

3. **æ•°æ®åº“æ“ä½œ**
   - è¿æ¥é‡è¯•
   - æ“ä½œé‡è¯•
   - é”™è¯¯è¯¦æƒ…

### é…ç½®çµæ´»æ€§

**å¯è°ƒå‚æ•°:**

- æ•°æ®åº“é‡è¯•æ¬¡æ•°å’Œå»¶è¿Ÿ
- å……å€¼é‡è¯•ç­–ç•¥
- å®šæ—¶ä»»åŠ¡å¼€å…³
- æ—¥å¿—çº§åˆ«
- Unitel APIè¶…æ—¶å’Œç¼“å­˜

---

## ğŸ§ª æµ‹è¯•è¦†ç›–

### åŠŸèƒ½æµ‹è¯•

- âœ… è®¢å•åˆ›å»ºæµç¨‹
- âœ… æ”¯ä»˜åˆ›å»ºæµç¨‹
- âœ… æ”¯ä»˜å›è°ƒå¤„ç†
- âœ… å……å€¼æ‰§è¡Œæµç¨‹
- âœ… å®šæ—¶ä»»åŠ¡è¡¥å¿

### å®‰å…¨æµ‹è¯•

- âœ… å¹¶å‘é‡å¤å……å€¼
- âœ… é‡‘é¢ç¯¡æ”¹æ£€æµ‹
- âœ… attachä¸ä¸€è‡´æ£€æµ‹
- âœ… ä¹è§‚é”ç«äº‰

### æ€§èƒ½æµ‹è¯•

- âœ… æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½
- âœ… å¹¶å‘å¤„ç†èƒ½åŠ›
- âœ… æ•…éšœæ¢å¤é€Ÿåº¦

---

## ğŸ“‹ éƒ¨ç½²è¦æ±‚

### ç¯å¢ƒå‡†å¤‡

- âœ… Node.js >= 16
- âœ… MySQL >= 8.0
- âœ… Prisma >= 5.0
- âœ… å¿…éœ€ç¯å¢ƒå˜é‡å·²é…ç½®

### æ•°æ®åº“å˜æ›´

- âœ… 3ä¸ªæ–°å­—æ®µ
- âœ… 3ä¸ªæ–°ç´¢å¼•
- âœ… å…¼å®¹ç°æœ‰æ•°æ®

### ä¾èµ–å˜æ›´

- âœ… æ— æ–°å¢å¤–éƒ¨ä¾èµ–
- âœ… ä»…ä¼˜åŒ–ç°æœ‰ä»£ç 

---

## ğŸ“ ç»éªŒæ€»ç»“

### æœ€ä½³å®è·µ

1. **å¹¶å‘æ§åˆ¶**
   - ä½¿ç”¨æ•°æ®åº“çº§åˆ«çš„ä¹è§‚é”
   - updateMany æ¯” update æ›´å®‰å…¨
   - æ£€æŸ¥ affected rows

2. **æ•°æ®éªŒè¯**
   - å¤šå±‚éªŒè¯æœºåˆ¶
   - è¯¦ç»†è®°å½•å¼‚å¸¸
   - ä¸å½±å“ä¸»æµç¨‹

3. **é”™è¯¯å¤„ç†**
   - åŒºåˆ†å¯é‡è¯•å’Œä¸å¯é‡è¯•é”™è¯¯
   - æŒ‡æ•°é€€é¿ç­–ç•¥
   - è¯¦ç»†çš„é”™è¯¯æ—¥å¿—

4. **æ€§èƒ½ä¼˜åŒ–**
   - åˆç†çš„ç´¢å¼•è®¾è®¡
   - é¿å…å…¨è¡¨æ‰«æ
   - å®šæ—¶ä»»åŠ¡åˆ†æ‰¹å¤„ç†

### é¿å…çš„å‘

1. âŒ ç›´æ¥ä½¿ç”¨ `update` è€Œä¸æ£€æŸ¥è¿”å›å€¼
2. âŒ æŸ¥è¯¢åæ›´æ–°(éåŸå­æ“ä½œ)
3. âŒ ç¼ºå°‘å¼‚å¸¸è®¢å•è¿½è¸ªæœºåˆ¶
4. âŒ ç¡¬ç¼–ç é…ç½®å€¼
5. âŒ å¿½ç•¥ä¸´æ—¶æ€§é”™è¯¯çš„é‡è¯•

---

## ğŸ“ åç»­æ”¯æŒ

### ç›‘æ§å»ºè®®

1. **æ¯æ—¥ç›‘æ§**
   - å……å€¼æˆåŠŸç‡ > 95%
   - å¼‚å¸¸è®¢å•æ•° < 1%
   - å¹³å‡å……å€¼å»¶è¿Ÿ < 5ç§’

2. **å‘Šè­¦é˜ˆå€¼**
   - å¾…è¡¥å¿è®¢å• > 10ä¸ª
   - å……å€¼å¤±è´¥ç‡ > 5%
   - æ•°æ®åº“é‡è¯• > 10æ¬¡/åˆ†é’Ÿ

3. **å®šæœŸæ£€æŸ¥**
   - æ¯å‘¨æŸ¥çœ‹å¼‚å¸¸è®¢å•
   - æ¯æœˆæ€§èƒ½åˆ†æ
   - æ¯å­£åº¦ä»£ç å®¡æŸ¥

### æ–‡æ¡£ç´¢å¼•

- [éƒ¨ç½²æŒ‡å—](./DEPLOYMENT_GUIDE_V2.md)
- [ç¯å¢ƒå˜é‡é…ç½®](./.env.example)
- [æ•°æ®åº“Schema](./prisma/schema.prisma)
- [APIæ–‡æ¡£](./docs/API.md) (å¦‚æœ‰)

---

## âœ¨ è‡´è°¢

æ„Ÿè°¢å¯¹ä»£ç è´¨é‡å’Œç³»ç»Ÿå®‰å…¨æ€§çš„é«˜åº¦é‡è§†,ä½¿å¾—æœ¬æ¬¡æ”¹è¿›å¾—ä»¥å…¨é¢å®æ–½ã€‚

---

**å®Œæˆæ—¥æœŸ:** 2025-01-18
**ç‰ˆæœ¬:** v2.0
**çŠ¶æ€:** âœ… ç”Ÿäº§å°±ç»ª
**ä¸‹ä¸€æ­¥:** éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒå¹¶ç›‘æ§
